# Issue: Preamble `byte[0]` State Machine and Exception Families

## Summary
- Working hypothesis: preamble `byte[0]` is mostly generated by a small serializer state machine, not arbitrary per-file rewriting.
- Corpus evidence supports this strongly, but not perfectly.
- The largest improvement came from changing propagation from `prev_active` to `prev_has_event`.
- `p01`-`p10` adds two important constraints:
  - T1 `0xB5` appears to be a **global multi-pattern mode marker**, not only a T1-pattern-count marker.
  - T5 exemption from `0x64` is **branch-dependent** (not absolute), with `p03` confirming the known outlier family.

## Repro Commands
- `python tools/hypothesis_tests.py h2-automaton`
- `python tools/hypothesis_tests.py h8-t5-exemption`

## Working Rule Candidate (v3, still partial)
For each logical entry (track+pattern block in playback order):

1. If `track == 1` and `pattern == 1` and **any track in the project is multi-pattern**, set `pre0 = 0xB5`.
2. Else if clone block, set `pre0 = 0x00`.
3. Else if previous logical entry has an event payload and `track != 5`, set `pre0 = 0x64`.
4. Else use slot/family baseline preamble value.

Notes:
- Rule 3 is still incomplete for T5. `p01`/`p02` keep T5 at `0x2E`, but
  `p03` (preset-changed T4 note path) sets T5 to `0x64`.
- So T5 behavior must include an event-family/preset branch term.

## `p01`-`p10` focused evidence

1. `p01` vs `p02`:
- T4 is active in both, and T5 remains `0x2E` in both.
- This confirms "active track before T5" is not enough by itself to force `0x64`.

2. `p03`:
- T4 active note path with preset change.
- T5 pre0 becomes `0x64`.
- This extends the known outlier set (`unnamed 113/116/117`) with a clean one-change specimen.

3. `p04`-`p10`:
- Every multi-pattern file sets T1 pre0 to `0xB5`, including cases where T1 is single-pattern (`p04`, `p05`, `p08`).
- This strongly supports "global multi-pattern mode marker" for T1 pre0.

### Why v2 (event-gated) instead of v1 (active-gated)?
- v1 (`prev_active`) explicit rule accuracy: `95.2%` (`2611/2743`).
- v2 (`prev_has_event`) explicit rule accuracy: `98.4%` (`2698/2743`).
- This implies many prior exceptions are explained by distinguishing:
  - tracks that are structurally active (`0x07`) vs
  - tracks that actually carry note event payloads.

## Current Exception Clusters (after v2)
`45/2743` logical rows remain unexplained.

Top clusters:
1. `(track=2, pred=0x8A, actual=0x92, prev_active=0, prev_has_event=0)` — `12` rows
2. `(track=1, pred=0xD6, actual=0xB5, prev_active=0, prev_has_event=0)` — `9` rows
3. `(track=4, pred=0x86|0x64, actual=0x61|0x60, prev_active=1)` — small modulation/live families
4. `T5` non-exempt cases (`pred=0x2E`, `actual=0x64`) — outlier family
   (`unnamed 113/116/117`, plus controlled repro `p03`)

## Likely Explanations for Exceptions

### 1) Slot-family baseline swaps (`0x8A -> 0x92`, etc.)
- Observed prominently in `unnamed 34*` family.
- Likely cause: alternate scaffold/template class (engine/preset family branch) that updates default preamble class values without using propagation.

### 2) T1 `0xB5` outside obvious multi-pattern count contexts
- Now consistently observed across controlled one-off captures `p04`-`p10`,
  including topologies where T1 itself is not multi-pattern (`p04`, `p05`, `p08`).
- Updated interpretation: this is likely a global multi-pattern-mode marker,
  not an anomaly.

### 3) Track 4 modulation/live-record families (`0x60/0x61`)
- Seen in files with pitch-bend/modwheel/live-oriented captures (`unnamed 39/97/106/108/120`).
- Likely cause: dedicated serializer branch for live/performance metadata that preserves a specialized track-class preamble value instead of generic `0x64` propagation.

### 4) T5 exemption is mostly true, not absolute
- `h8-t5-exemption` shows T5 usually stays `0x2E` when following active T4, but not always.
- Outliers: `unnamed 113`, `unnamed 116`, `unnamed 117`, `p03`.
- `p01`/`p02` vs `p03` strongly suggests a preset/event-family branch can bypass
  the usual T5 guard.

## Practical Guidance (for writer/modeling work)
- Prefer the event-gated rule (`prev_has_event`) as default rather than raw `prev_active`.
- Keep explicit per-family overrides for known exception clusters until isolated.
- Treat preamble generation as a layered model:
  1. baseline slot class
  2. branch overrides (multi-pattern/clone/live/performance)
  3. event-gated propagation
- For multi-pattern authoring, force T1 pre0 to `0xB5` whenever any track uses
  `pattern_count > 1` (device-backed by `p04`-`p10`).

## Next Experiments
1. Add a dedicated corpus classifier for exception families (baseline swap vs live/perf vs multi-pattern artifacts).
2. Capture controlled A/B device files:
   - same track active with/without note event payload
   - same track with note event vs CC/p-lock-only change
   - focused T5 outlier reproduction based on 113/116/117 workflow.
3. Once exception families are isolated, promote stable portions of this model into `docs/format/track_blocks.md`.
